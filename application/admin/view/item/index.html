{include file="public/header" /}
{include file="public/breadcrumb" /}
<link href="/static/plugins/iCheck/custom.css" rel="stylesheet">
<!--<link href="/static/plugins/dropzone/basic.css" rel="stylesheet">-->
<!--<link href="/static/plugins/dropzone/dropzone.css" rel="stylesheet">-->

<div class="wrapper wrapper-content animated fadeInRight tooltip-demo">
    <div class="ibox-title">
        <h5 class="">服务项目列表</h5>
        <div class="ibox-tools">
            <span class="btn btn-success btn-xs pull-left m-l" type="button" onclick="$('#item-list-modal').modal('show');" data-target="#admin-user-modal" data-tip="tooltip" data-placement="top" title="" data-original-title="添加服务项目"><i class="fa fa-plus"></i>&nbsp;添加</span>
            <span class="btn btn-danger btn-xs pull-left m-l" type="button" onclick="delProduct()" data-tip="tooltip" data-placement="top" title="" data-original-title="删除项目"><i class="fa fa-minus"></i>&nbsp;删除</span>
        </div>
    </div>
    <div class="row">
        {volist name="list" id="vo"}
        <div class="col-md-3">
            <div class="ibox">
                <div class="ibox-content product-box">
                    <div class="product-imitation">
                        <img src="{$vo.origin_image}" alt="">
                    </div>
                    <div class="product-desc">
                        <span class="product-price">
                            ￥{$vo.price}
                        </span>
                        <small class="text-muted">{$vo.cate_name}</small>
                        <a href="{:url('addEditItem',['item_id'=>$vo['item_id']])}" class="product-name"> {$vo.title}</a>
                        <div class="small m-t-xs">{$vo.description,$vo.item_id}</div>
                        <div class="m-t text-righ">

                            <a onclick="changeOnSale('{$vo.item_id}',0,this)" class="btn btn-xs btn-outline btn-warning toggle-down {if $vo.on_sale==0}hidden{/if}">下架 <i class="fa fa-long-arrow-down"></i> </a>
                            <a onclick="changeOnSale('{$vo.item_id}',1,this)" class="btn btn-xs btn-outline btn-success toggle-up {if $vo.on_sale==1}hidden{/if}">上架 <i class="fa fa-long-arrow-up"></i> </a>

                            <a onclick="getDataForModal('/admin/item/addEditItem/id/{$vo.item_id}')" data-toggle="modal" data-target="#item-list-modal" class="btn btn-xs btn-outline btn-primary m-l-lg">编辑修改 <i class="fa fa-long-arrow-right"></i> </a>
                            <span class="i-checks pull-right"><label> <input type="checkbox" value="{$vo['item_id']}" class="del"> <i></i></label></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {/volist}
    </div>
    {$page}
</div>

<div class="modal inmodal" id="item-list-modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">

    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" onclick="closeModalComm(this)"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h5 class="modal-title">添加/修改 服务项目</h5>
            </div>
            <form id="addEditItemForm">
                <div class="modal-body" v-if="list.hasOwnProperty('user')">

                    <input type="hidden" name="id" v-model="list.user.id">
                </div>

                <div class="modal-body" v-else>
                    <div class="tabs-container">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab-1"> 项目详情</a></li>
                            <li class=""><a data-toggle="tab" href="#tab-2"> 轮播图片</a></li>
                        </ul>
                        <div class="tab-content">
                            <div id="tab-1" class="tab-pane active">
                                <div class="panel-body">

                                    <fieldset class="form-horizontal">
                                        <div class="form-group"><label class="col-sm-2 control-label">项目名称:</label>
                                            <div class="col-sm-10"><input type="text" class="form-control" placeholder="Product name" name="title" value=""></div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">价格:</label>
                                            <div class="col-sm-10">
                                                <div class="input-group">
                                                    <span class="input-group-addon">￥</span>
                                                    <input type="text" class="form-control" placeholder="160.00" name="price" value="">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">原价:</label>
                                            <div class="col-sm-10">
                                                <div class="input-group">
                                                    <span class="input-group-addon">￥</span>
                                                    <input type="text" class="form-control" placeholder="200.00" name="market_price" value="">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">赠送积分:</label>
                                            <div class="col-sm-10"><input type="text" class="form-control" name="give_integral" placeholder="0"></div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">一级分类:</label>
                                            <div class="col-sm-10">
                                                <select class="form-control" name="cate_id" v-model="cur1">
                                                    <option value="0">请选择</option>
                                                    <option v-for="(vo1,index) in cate1" :value="index">{{vo1}}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">二级分类:</label>
                                            <div class="col-sm-10">
                                                <select class="form-control" name="cate_id2" v-model="cur2">
                                                    <option value="0">请选择</option>
                                                    <option v-for="(vo2,keys) in cate2" :value="keys">{{vo2}}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">简介描述:</label>
                                            <div class="col-sm-10">
                                                <textarea name="description" id="description" rows="3" class="form-control"></textarea>
                                            </div>
                                        </div>
                                        <div class="form-group"><label class="col-sm-2 control-label">项目详情:</label>
                                            <div class="col-sm-10">
                                                <script id="container" name="content" type="text/plain"></script>
                                            </div>
                                        </div>

                                    </fieldset>

                                </div>
                            </div>
                            <div id="tab-2" class="tab-pane">
                                <div class="panel-body">

                                    <div class="table-responsive">
                                        <table class="table table-bordered table-stripped">
                                            <thead>
                                            <tr>
                                                <th>
                                                    预览
                                                </th>
                                                <th>
                                                    排序
                                                </th>
                                                <th>
                                                    删除
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                <td>
                                                    <a href="javascript:;" class="file">
                                                        <div class="fileList" id="fileList1"><img src=""></div>
                                                        <input name="image1" onchange="handleFiles(this,1)" type="file" accept="image/*" />
                                                    </a>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" value="1">
                                                </td>
                                                <td>
                                                    <button class="btn btn-white" type="button" onclick="delimage(1)"><i class="fa fa-trash"></i> </button>
                                                </td>
                                            </tr>
                                                <tr>
                                                    <td>
                                                        <a href="javascript:;" class="file">
                                                            <div class="fileList" id="fileList2"><img src=""></div>
                                                            <input name="image2" onchange="handleFiles(this,2)" type="file" accept="image/*" />
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control" value="1">
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-white" type="button" onclick="delimage(2)"><i class="fa fa-trash"></i> </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <a href="javascript:;" class="file">
                                                            <div class="fileList" id="fileList3"><img src=""></div>
                                                            <input name="image3" onchange="handleFiles(this,3)" type="file" accept="image/*" />
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control" value="1">
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-white" type="button" onclick="delimage(3)"><i class="fa fa-trash"></i> </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <a href="javascript:;" class="file">
                                                            <div class="fileList" id="fileList4"><img src=""></div>
                                                            <input name="image4" onchange="handleFiles(this,4)" type="file" accept="image/*" />
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <input type="text" name="srot" class="form-control" value="4">
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-white" type="button" onclick="delimage(4)"><i class="fa fa-trash"></i> </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <a href="javascript:;" class="file">
                                                            <div class="fileList" id="fileList5"><img src=""></div>
                                                            <input name="image5" onchange="handleFiles(this,5)" type="file" accept="image/*" />
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <input type="text" name="sort" class="form-control" value="1">
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-white" type="button" onclick="delimage(5)"><i class="fa fa-trash"></i> </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <input type="hidden" name="origin_image" id="origin_image">
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" onclick="closeModalComm(this)">关 闭</button>
                    <button type="submit" class="btn btn-primary">保 存</button>
                </div>
            </form>
        </div>
    </div>

</div>
<script src="/static/js/vue.min.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<script src="/static/plugins/ueditor/ueditor.config.js"></script>
<script src="/static/plugins/ueditor/ueditor.all.min.js"></script>
<script src="/static/plugins/layer/mobile/layer.js"></script>
<script src="/static/plugins/lrz/lrz.all.bundle.js"></script>
<!--<script src="/static/plugins/dropzone/dropzone.js"></script>-->
<script>
    $(document).ready(function () {
        $('.i-checks').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green'
        });
        $(".footer").hide();
        var ue = UE.getEditor('container',{
            toolbars: [[
                'fullscreen', 'source', '|', 'undo', 'redo', '|',
                'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                'fontfamily', 'fontsize', 'indent', '|',
                'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|',
                'link', 'unlink', 'anchor', '|',
                'simpleupload', 'insertimage', 'emotion', 'scrawl', 'insertvideo', 'music', 'attachment', 'map', 'pagebreak', 'template', 'background', '|',
                'horizontal', 'date', 'time', 'spechars', 'snapscreen', '|',
                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
                'searchreplace', 'drafts'
            ]],
            autoFloatEnable:true
        });

        ue.ready(function() {
            //设置编辑器的内容
            ue.setContent(vm.content);
        });

        $("#addEditItemForm").validate({
            rules: {
                title: "required",
                price: {
                    required:true,
                    min:0,
                    number:true
                },
                market_price: {
                    required:true,
                    min:0,
                    number:true
                },
                give_integral: {
                    min:0,
                    digits:true
                },
                cate_id: {required:true,min:1},
                cate_id2: {required:true,min:1},
                description: "required",
                origin_image: "required"
            },
            messages: {
                title: "服务项目的名称一定要填写哦",
                price: "服务价格必须填大于0的数字",
                market_price: "原价必须填大于0的数字",
                give_integral: "赠送积分只能是正整数呀",
                cate_id: "请选择一级分类",
                cate_id2: "请选择二级分类",
                description: "请填写项目简介",
                origin_image: "至少上传一张主图"
            },
            submitHandler: function (form) {
                var index=layer.open({type:2,shadeClose: false});
                $.ajax({
                    type: 'POST',
                    url: '/admin/item/addEditItem',
                    data: $(form).serialize(),
                    success: function (data) {
                        if (data.succ == 0){
                            layer.close(index);
                            layer.open({
                                content:'保存成功',
                                skin:'msg',
                                time:1.5,
                                end: function(elem){
                                    location.reload();
                                }
                            });
                        }
                        else
                            toastr.warning(data.msg);
                    },
                    error: function (e) {
                        err();
                    }
                });
            }
        });
    });

    function delProduct() {
        ids = '';
        $.each($('input:checkbox:checked'), function () {
            if (ids=='')
                ids = $(this).val();
            else
                ids += ',' + $(this).val();
        });

        if (!ids){
            toastr.warning('请勾选需要删除的项目..');
            return false;
        }

        swal({
            title: "确定要删除吗?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false
        }, function () {
            $.ajax({
                type: 'POST',
                url: '/admin/item/deleteItem.html',
                data: {ids: ids},
                success: function (data) {
                    if (data.succ == 0) {
                        location.reload();
                    } else {
                        toastr.error(data.msg);
                    }
                },
                error: function (xhr, type) {
                    err();
                }
            });
        });
    }

    function changeOnSale(id,val,obj){
        classname=val==1?'.toggle-down':'.toggle-up';
        $.ajax({
            type: 'POST',
            url: '/admin/index/changeTableVal.html',
            data: {
                "table": 'item',
                "id_name": 'item_id',
                "id_value": id,
                "field": 'on_sale',
                "value": val
            },
            success: function (data) {
                if (data){
                    $(obj).addClass('hidden').siblings(classname).removeClass('hidden');
                }else{
                    toastr.warning('操作失败');
                }
            },
            error: function (e) {
                toastr.err('网络错误，请稍后再试');
            }
        });
    }

    function init(){
        $.ajax({
            type: 'POST',
            url: '/admin/item/getCate.html',
            success: function (data) {
                if (data.succ==0){
                    vm.cate1=data.data.cate1;
                    vm.cate2=data.data.cate2;
                }else{
                    toastr.warning(data.msg);
                }
            },
            error: function (e) {
                toastr.error('网络异常，请稍后再试');
            }
        });
    }

    var vm=new Vue({
        el:"#wrapper",
        data:{
            init_data:{},
            list:{},
            total:1,
            p:1,
            cate1:{},
            cate2:{},
            cur1:0,
            cur2:0,
            content:''
        },
        created:function(){
            init();
        }
    });
    // var myDropzone = new Dropzone(".aaa", {
    //     url: "/admin/index/uploader",
    //     dictDefaultMessage:"点击上传",
    //     previewsContainer:".aaa",
    //     clickable:true,
    //     thumbnailWidth:50,
    //     thumbnailHeight:50,
    //     init: function () {
    //         //res为服务器响应回来的数据
    //         this.on("success", function (file, res) {
    //             if (res.succ == 0) {
    //                 //将服务器得到的数据生成一个隐藏域。做商品添加的时候就可以获取到了
    //                 this.clickableElements[0].nextElementSibling.value = res.data;
    //             } else {
    //                 toastr.error(res.msg);
    //             }
    //         });
    //
    //         this.on("removedfile", function (file) {
    //             $.ajax({
    //                 url: "/admin/index/delimage",
    //                 type: "post",
    //                 //file.path可以获取到点击删除按钮的那张图片
    //                 data: {'path': file.path},
    //                 success:function(res){
    //                     console.log(res);
    //                 }
    //             });
    //         });
    //     }
    // });

    function handleFiles(obj,id) {
        fileList = document.getElementById("fileList"+id);
        var files = obj.files;
        img = new Image();
        if(window.URL){

            img.src = window.URL.createObjectURL(files[0]); //创建一个object URL，并不是你的本地路径
            img.width = 80;
            img.height = 80;
            img.onload = function(e) {
                window.URL.revokeObjectURL(this.src); //图片加载后，释放object URL
            }
            if(fileList.firstElementChild){
                fileList.removeChild(fileList.firstElementChild);
            }
            fileList.appendChild(img);
        }else {
            toastr.error('图片预览错误！');
        }
    }

    function delimage(id){
        fileList = document.getElementById("fileList"+id);
        if(fileList.firstElementChild){
            fileList.removeChild(fileList.firstElementChild);
        }
        document.getElementsByName('image'+id)[0].value='';
    }
    //兼容浏览器图片预览
    // if(window.FileReader){
    //     //opera不支持createObjectURL/revokeObjectURL方法。我们用FileReader对象来处理
    //     var reader = new FileReader();
    //     reader.readAsDataURL(files[0]);
    //     reader.onload = function(e){
    //         img.src = this.result;
    //         img.width = 80;
    //         img.height = 80;
    //         fileList.appendChild(img);
    //     }
    // }else {
    //     //ie
    //     obj.select();
    //     obj.blur();
    //     var nfile = document.selection.createRange().text;
    //     document.selection.empty();
    //     img.src = nfile;
    //     img.width = 80;
    //     img.height = 80;
    //     img.onload=function(){
    //
    //     }
    //     fileList.appendChild(img);
    // }

</script>
{include file="public/footer" /}