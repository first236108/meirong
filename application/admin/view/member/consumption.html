{include file="public/header" /}
{include file="public/breadcrumb" /}
<link href="/static/plugins/dataTables/datatables.min.css" rel="stylesheet">
<link href="/static/plugins/datapicker/datepicker3.css" rel="stylesheet">
<link href="/static/plugins/iCheck/custom.css" rel="stylesheet">
<link href="/static/plugins/switchery/switchery.css" rel="stylesheet">
<link href="/static/plugins/ladda/ladda-themeless.min.css" rel="stylesheet">
<div class="wrapper wrapper-content animated fadeInRight ecommerce tooltip-demo" style="padding-top:10px">

    <div class="ibox-content m-b-sm border-bottom p-m-10">
        <div class="row" id="search-bar">
            <form id="top-search" method="post" action="/admin/member/recharge.html">
                <div class="col-sm-2">
                    <div class="form-group">
                        <label class="control-label" for="type">订单类型</label>
                        <select name="type" id="type" v-model="type" class="form-control">
                            <option value="false">所有订单</option>
                            <option value="1">包含赠送</option>
                            <option value="0">不含赠送</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="start_time">开始时间</label>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" id="start_time" name="start_time" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="end_time">截止时间</label>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" id="end_time" name="end_time" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="col-sm-1">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary btn-block" data-tip="tooltip" data-placement="top" data-original-title="搜索">Go</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-content">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="table">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal fade" id="order-detail" tabindex="-2" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">订单详情</h4>
                    <small class="font-bold">Lorem Ipsum is simply dummy text of the printing and typesetting industry.</small>
                </div>
                <div class="modal-body">
                    <div class="ibox-content">
                        <div class="row">
                            <dl class="dl-horizontal">
                                <dt>订单编号</dt>
                                <dd>{{order_detail.order.order_sn}}</dd>
                                <dt>支付时间</dt>
                                <dd>{{order_detail.order.pay_time}}</dd>
                                <dt>服务项目合计金额</dt>
                                <dd>￥ {{order_detail.order.order_amount}}</dd>
                                <dt v-if="order_detail.order.order_prom_amount>0">订单活动减免</dt>
                                <dt v-if="order_detail.order.order_prom_amount>0">￥ {{order_detail.order.order_prom_amount}}</dt>
                                <dt v-if="order_detail.order.manger_reduce>0">商家优惠金额</dt>
                                <dt v-if="order_detail.order.manger_reduce>0">￥ {{order_detail.order.manger_reduce}}</dt>
                                <dt v-if="order_detail.order.coupou_amount>0">优惠券抵扣</dt>
                                <dt v-if="order_detail.order.coupon_amount>0">￥ {{order_detail.order.coupon_amount}}</dt>
                                <dt v-if="order_detail.order.points_amount>0">积分抵扣</dt>
                                <dt v-if="order_detail.order.points_amount>0">￥ {{order_detail.order.points_amount}}</dt>
                                <dt>实付金额</dt>
                                <dd class="text-danger">￥ {{order_detail.order.pay_amount}}</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <ul class="sortable-list connectList agile-list" id="completed">
                            <li :class="[item.dec_num>0?'info-element':'success-element']" v-for="(item,index) in order_detail.order_item">
                                {{item.title}}
                                <div class="agile-detail">
                                    <a onclick="javascript:;" class="pull-right btn btn-xs btn-white" v-if="item.dec_num==0">已全部消费</a>
                                    <i class="fa fa-battery"></i>&nbsp;<span class="text-success">服务次数：{{item.num}}</span><br/>
                                    <i :class="['fa','fa-battery-'+Math.round(item.dec_num/item.num*4)]"></i>&nbsp;<span class="text-danger">剩余次数：{{item.dec_num}}</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal inmodal fade" id="msg-modal" tabindex="-3" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h5 class="modal-title" id="msg-title"></h5>
                </div>
                <div class="modal-body">
                    <p id="msg-content"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-white" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal inmodal fade" id="remark-modal" tabindex="3" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h5 class="modal-title text-success">添加备注</h5>
                </div>
                <div class="modal-body">
                    <textarea id="remark-content" cols="30" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="ladda-button btn btn-primary" data-style="zoom-in" id="ladda-btn">
                        保 存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/vue.min.js"></script>
<script src="/static/js/axios.min.js"></script>
<script src="/static/plugins/dataTables/datatables.min.js"></script>
<script src="/static/plugins/datapicker/bootstrap-datepicker.js"></script>
<script src="/static/plugins/layer/mobile/layer.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<script src="/static/plugins/switchery/switchery.js"></script>
<script src="/static/plugins/ladda/spin.min.js"></script>
<script src="/static/plugins/ladda/ladda.min.js"></script>
<script src="/static/plugins/ladda/ladda.jquery.min.js"></script>
<script>
    var l;
    var fields = [];
    var search_thread = null;
    var cid = 0;
    $(document).ready(function () {
        l = $('#table').DataTable({
            serverSide: true,//服务器模式
            pageLength: 10,
            responsive: true,
            processing: true,//显示处理状态，排序、加载时
            searchDelay: 500,//自动搜索延迟
            order: [[4, 'desc']],
            bInfo: true,//不显示分页信息
            aoColumnDefs: [
                {"orderable": false, "aTargets": [1, 7, 8]}// 制定列不参与排序
            ],
            language: {
                info: "当前显示第 _START_ 至 _END_ 条, 共 _TOTAL_ 条记录",
                lengthMenu: "每页显示 _MENU_ 条",
                search: "搜索",
                searchPlaceholder: '会员性名/昵称/手机号',
                sZeroRecords: "没有匹配结果",
                sLoadingRecords: "载入中...",
                sProcessing: "处理中...",
                oAria: {
                    "sSortAscending": ": 升序排列",
                    "sSortDescending": ": 降序排列"
                },
                oPaginate: {
                    "sFirst": "第一页",
                    "sPrevious": "上一页",
                    "sNext": "下一页",
                    "sLast": "最后一页"
                }
            },
            dom: '<"html5buttons"B>lTfgtip',
            search: {
                smart: false,
                search: '{$phone}'//默认搜索内容
            },
            buttons: [
                {extend: 'copy'},
                {extend: 'excel', title: 'ExampleFile'},
                {
                    extend: 'print',
                    customize: function (win) {
                        $(win.document.body).addClass('white-bg');
                        $(win.document.body).css('font-size', '10px');

                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit');
                    }
                },
                {
                    sExtends: 'add',
                    text: '充值',
                    action: function (e, dt, node, config) {
                        $('#order-add-modal').modal('show');
                        getItems();
                    }
                }
            ],
            // ajax:'/admin/member/consumption',
            ajax: function (data, callback, settings) {
                var param = {};
                if (fields.length == 0) {
                    data.columns.forEach(function (value, index) {
                        fields[index] = value['data'];
                    });
                }
                param.limit = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
                param.start = data.start;//开始的记录序号
                param.page = (data.start / data.length) + 1;//当前页码
                param.fields = fields;
                param.order = data.order;
                param.search = data.search.value;//当前页码

                $.ajax({
                    type: "POST",
                    url: "/admin/member/consumption",
                    cache: false,  //禁用缓存
                    data: param,  //传入组装的参数
                    dataType: "json",
                    success: function (result) {
                        //封装返回数据
                        setTimeout(function () {
                            var returnData = {};
                            returnData.draw = data.draw;//这里直接自行返回了draw计数器,应该由后台返回
                            returnData.recordsTotal = result.data.length;//返回数据全部记录
                            returnData.recordsFiltered = result.total;//后台不实现过滤功能，每次查询均视作全部结果
                            returnData.data = result.data;//返回的数据列表
                            //调用DataTables提供的callback方法，代表数据已封装完成并传回DataTables进行渲染
                            callback(returnData);
                        }, 50);
                    },
                    error: function (xhr, type) {
                        console.log(xhr);
                        console.log(type);
                    }
                });
            },
            columns: [
                {data: "nickname", title: "会员昵称"},
                {
                    data: "avatar",
                    title: "头像",
                    render: function (data, type, row, meta) {
                        return data = '<img class="img-circle chat-avatar" src="' + data + '">';
                    }
                },
                {data: "phone", title: "联系方式"},
                {data: "title", title: "服务项目"},
                {data: "add_time", title: "消费时间"},
                {data: "confirm", title: "跟单技师"},
                {data: "scroe", title: "评分"},
                {
                    data: "msg",
                    title: "留言",
                    class: "msg",
                    render: function (data, type, row, meta) {
                        if (data.length > 20) {
                            data = '<span title="' + data + '">' + data.substr(0, 20) + '...</span>';
                        }
                        return data;
                    }
                },
                {
                    data: "remark",
                    title: "备注/操作",
                    class: "remark",
                    render: function (data, type, row, meta) {
                        if (data) {
                            if (data.length > 20) {
                                data = '<span title="' + data + '">' + data.substr(0, 20) + '...</span>';
                            }
                            return data;
                        }
                        return '<button type="button" class="btn btn-white btn-xs" href="#" onclick="mark(' + row.cid + ')" >添加备注</button>';
                    }
                }
            ]
        });

        //搜索延迟
        $(".dataTables_filter input").unbind().bind("input", function (e) {
            clearTimeout(search_thread);
            search_thread = setTimeout(function () {
                var elem = $(".dataTables_filter input");
                return l.search($(elem).val()).draw();
            }, 500);
        });

        $('#search-bar .input-group.date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            calendarWeeks: true,
            autoclose: true
        });

        $("#top-search").validate({
            rules: {
                start_time: {
                    date: true
                },
                end_time: {
                    date: true
                },
                nameorphone: {
                    minlength: 1
                }
            },
            messages: {
                create_time: "开始时间 错误",
                last_time: "截止时间 错误",
                nameorphone: "手机号/名字 长度错误"
            },
//            submitHandler: function (form) {
//                $.ajax({
//                    type: 'POST',
//                    url: '/admin/member/recharge',
//                    data: $(form).serialize(),
//                    success: function (data) {
//                        layer.open({
//                            content: '数据已更新',
//                            skin: 'msg',
//                            time: 1
//                        });
//                        vm.list = data[0];
//                        vm.sum_amount = data[3];
//                        vm.total_amount = data[4];
//                    },
//                    error: function (xhr, type) {
//                        err(xhr.responseText);
//                    }
//                });
//            }
        });

        var btn = $("#ladda-btn").ladda();
        btn.click(function () {
            btn.ladda('start');
            axios.post('/admin/index/changeTableVal', {
                'table': 'consumption',
                'id_name': 'cid',
                'id_value': cid,
                'field': 'remark',
                'value': $("#remark-content").val()
            }).then(function (response) {
                btn.ladda('stop');
                $("#remark-content").val('');
                $("#remark-modal").modal('hide');
                l.ajax.reload();
            }).catch(function (error) {
                btn.ladda('stop');
                err(error.response.data);
            });
        });
    });

    //超长字符点击td显示模态框
    $('#table').on('click', 'td', function (e) {
        if (this.className.indexOf('msg') > 0 && this.children.length > 0) {
            $("#msg-title").html(this.parentElement.firstElementChild.innerHTML + ' 留言');
            $("#msg-content").html((this.children[0].getAttribute('title')));
            $("#msg-modal").modal('show');
        }
        if (this.className.indexOf('remark') > 0 && this.children[0].getAttribute('title')) {
            $("#msg-title").html(this.parentNode.children[5].innerHTML + ' 备注');
            $("#msg-content").html(this.children[0].getAttribute('title'));
            $("#msg-modal").modal('show');
        }
    });

    function mark(id) {
        cid = id;
        $("#remark-modal").modal('show');
    }
</script>
{include file="public/footer" /}