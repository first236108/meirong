{include file="public/header" /}
{include file="public/breadcrumb" /}
<link href="/static/plugins/dataTables/datatables.min.css" rel="stylesheet">
<link href="/static/plugins/datapicker/datepicker3.css" rel="stylesheet">
<link href="/static/plugins/iCheck/custom.css" rel="stylesheet">
<div class="wrapper wrapper-content animated fadeInRight ecommerce tooltip-demo" style="padding-top:10px">

    <div class="ibox-content m-b-sm border-bottom p-m-10">
        <div class="row" id="search-bar">
            <form id="top-search">
                <div class="col-sm-2">
                    <div class="form-group">
                        <label class="control-label" for="is_valid">会员状态</label>
                        <select name="is_valid" id="is_valid" v-model="valid" class="form-control">
                            <option value="1">正常</option>
                            <option value="0">黑名单</option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="create_time">注册时间</label>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" id="create_time" name="create_time" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="last_come">到店时间</label>
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" id="last_come" name="last_come" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label class="control-label" for="nameorphone">搜索词</label>
                        <input type="text" id="nameorphone" name="nameorphone" value="" placeholder="手机号/名字/昵称" class="form-control">
                    </div>
                </div>
                <div class="col-sm-1">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary btn-block" data-tip="tooltip" data-placement="top" data-original-title="搜索">Go</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-content">

                    <table class="table table-responsive" data-sorting="true">
                        <thead>
                        <tr>
                            <th data-toggle="true" class="first-td">姓名</th>
                            <th data-breakpoints="xs">电话</th>
                            <th data-type="number">累计充值</th>
                            <th data-breakpoints="all">昵称</th>
                            <th data-breakpoints="all">头像</th>
                            <th data-breakpoints="all">会员等级</th>
                            <th data-breakpoints="all" data-type="number">累计充值</th>
                            <th data-breakpoints="xs">上次到店时间</th>
                            <th data-breakpoints="xs">Status</th>
                            <th class="text-right" data-breakpoints="xs" data-sort-ignore="true">修改</th>
                            <th class="text-right" data-sort-ignore="true">查看记录</th>

                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="(user,index) in list">
                            <td class="first-td">{{user.name}}</td>
                            <td>{{user.phone}}</td>
                            <td>{{user.total_recharge}}</td>
                            <td>{{user.nickname}}</td>
                            <td><img :src="user.avatar" :alt="user.name" class="img-circle" style="max-width:2rem"></td>
                            <td>{{level[user.level]}}</td>
                            <td>
                                <span class="text-danger"><i class="fa fa-yen"></i>&nbsp;{{user.money}}</span>
                            </td>
                            <td>{{user.last_come}}</td>
                            <td>
                                <span class="label label-primary" v-if="user.is_valid==1" @click="toggleStatus(user.user_id,0,index)">正常</span>
                                <span class="label label-danger" v-else @click="toggleStatus(user.user_id,1,index)">黑名单</span>
                            </td>
                            <td v-if="user.is_valid==1">
                                <button class="btn btn-default btn-outline btn-xs" @click="editUser(index)"><i class="fa fa-edit">修改</i></button>
                            </td>
                            <td v-else>
                                <button class="btn btn-danger btn-outline btn-xs" @click="delUser(user.user_id,index)"><i class="fa fa-times">删除会员</i></button>
                            </td>
                            <td class="text-right">
                                <div class="btn-group">
                                    <button class="btn-info btn btn-outline btn-xs"><i class="fa fa-yen"></i>充值</button>
                                    <button class="btn-success btn btn-outline btn-xs"><i class="fa fa-vimeo-square"></i>消费</button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="6">
                                <div class="pull-left" id="member-add">
                                    <button class="btn btn-outline btn-success btn-xs btn-xs" type="button" onclick="$('#user-add-modal').modal('show');" data-target="#user-add-modal" data-tip="tooltip" data-placement="right" data-original-title="新增会员"><i class="fa fa-plus"></i></button>
                                </div>
                                <span style="clear:both"></span>
                                <div style="display:inline" id="paging-ui-container"></div>
                            </td>
                        </tr>
                        </tfoot>
                    </table>

                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="user-add-modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content animated fadeIn">
                <div class="modal-header">
                    <button type="button" class="close" onclick="closeModalComm(this);vm.edit={};"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h5 class="modal-title">添加/修改 会员资料</h5>
                </div>
                <form id="user-add-form" class="form-horizontal">
                    <div class="modal-body" v-if="edit.hasOwnProperty('user_id')">
                        <input type="hidden" v-model="edit.user_id" name="user_id">
                        <div class="form-group"><label class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10"><input v-model="edit.name" type="text" class="form-control" name="name" id="name"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">昵称</label>
                            <div class="col-sm-10"><input v-model="edit.nickname" type="text" class="form-control" name="nickname" id="nickname"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">手机号码</label>
                            <div class="col-sm-10"><input v-model="edit.phone" type="text" class="form-control" name="phone" id="phone" autocomplete="off"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">登陆密码</label>
                            <input type="password" class="hidden"/>
                            <div class="col-sm-10"><input type="password" class="form-control" name="password" autocomplete="off"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label" for="level">会员等级</label>
                            <div class="col-sm-10">
                                <select class="form-control m-b" name="level" id="level" v-model="edit.level">
                                    <option v-for="(lv,key) in level" :value="key">{{lv}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">性别</label>

                            <div class="col-sm-10">
                                <label class="i-checks m-r-lg"> <input type="radio" v-model="edit.sex" value="0" name="sex"> <i></i> 美女 </label>
                                <label class="i-checks"> <input type="radio" v-model="edit.sex" value="1" name="sex"> <i></i> 鲜森 </label>
                            </div>
                        </div>

                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">住址</label>
                            <div class="col-sm-10"><input type="text" v-model="edit.address" class="form-control" name="address" autocomplete="off"></div>
                        </div>

                    </div>
                    <div class="modal-body" v-else>
                        <div class="form-group"><label class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="name" id="name"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">昵称</label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="nickname" id="nickname"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">手机号码</label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="phone" id="phone" autocomplete="off"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">登陆密码</label>
                            <input type="password" class="hidden"/>
                            <div class="col-sm-10"><input type="password" class="form-control" name="password" autocomplete="off"></div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label" for="level">会员等级</label>
                            <div class="col-sm-10">
                                <select class="form-control m-b" name="level" id="level">
                                    <option v-for="(lv,key) in level" :value="key">{{lv}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">性别</label>

                            <div class="col-sm-10">
                                <label class="i-checks m-r-lg"> <input type="radio" checked="" value="0" name="sex"> <i></i> 美女 </label>
                                <label class="i-checks"> <input type="radio" value="1" name="sex"> <i></i> 鲜森 </label>
                            </div>
                        </div>

                        <div class="hr-line-dashed"></div>
                        <div class="form-group"><label class="col-sm-2 control-label">住址</label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="address" autocomplete="off"></div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" onclick="closeModalComm(this);vm.edit={};">关 闭</button>
                        <button type="submit" class="btn btn-primary">保 存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/vue.min.js"></script>
<script src="/static/js/axios.min.js"></script>
<script src="/static/plugins/moment/moment.min.js"></script>
<script src="/static/plugins/dataTables/datatables.min.js"></script>
<script src="/static/plugins/datapicker/bootstrap-datepicker.js"></script>
<script src="/static/plugins/layer/mobile/layer.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<script>
    $(document).ready(function () {
        // var ft=$('.footable').footable({
        //     "paging": {
        //         "enabled": true,
        //         "size": 20,
        //         "position": "right",
        //         "container": "#paging-ui-container"
        //     },
        //     editing:{
        //         "enabled": true,
        //         "allowAdd":true,
        //         "addRow":true
        //     }
        // });
        $('#search-bar .input-group.date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            calendarWeeks: true,
            autoclose: true
        });

        $("#top-search").validate({
            rules: {
                create_time: {
                    date: true
                },
                last_time: {
                    date: true
                },
                nameorphone: {
                    minlength: 1
                }
            },
            messages: {
                create_time: "注册时间 错误",
                last_time: "到店时间 错误",
                nameorphone: "手机号/名字 长度错误"
            },
            submitHandler: function (form) {
                $.ajax({
                    type: 'POST',
                    url: '/admin/member/index',
                    data: $(form).serialize(),
                    success: function (data) {
                        layer.open({
                            content: '数据已更新',
                            skin: 'msg',
                            time: 1
                        });
                        vm.list = data[0];
                    },
                    error: function (xhr, type) {
                        err(xhr.responseText);
                    }
                });
            }
        });

        $("#user-add-form").validate({
            rules: {
                phone: {
                    required: true,
                    digits: true
                }
            },
            messages: {
                phone: "手机号码格式错误"
            },
            submitHandler: function (form) {
                if (!document.getElementById('name').value && !document.getElementById('nickname').value) {
                    layer.open({content: '清填写姓名或昵称', skin: 'msg', time: 1.5});
                    return false;
                }
                var reg = /(^1[3|4|5|7|8][0-9]{9}$)/;
                if (!reg.test(document.getElementById('phone').value)) {
                    layer.open({content: '手机号码格式错误', skin: 'msg', time: 1.5});
                    return false;
                }

                $.ajax({
                    type: 'POST',
                    url: '/admin/member/addEditMember',
                    data: $(form).serialize(),
                    success: function (data) {
                        layer.open({
                            content: '保存成功',
                            skin: 'msg',
                            time: 1,
                            end: function (elem) {
                                location.reload();
                            }
                        });
                    },
                    error: function (xhr, type) {
                        err(xhr.responseText);
                    }
                });
            }
        });
    });

    var vm = new Vue({
        el: '#wrapper',
        data: {
            valid:1,
            list: [],
            level: [],
            edit:{}
        },
        created: function () {
            init();
        },
        methods: {
            toggleStatus: function (user_id, status, index) {
                axios.post('/admin/index/changeTableVal', {
                    'table': 'users',
                    'id_name': 'user_id',
                    'id_value': user_id,
                    'field': 'is_valid',
                    'value': status,
                }).then(function (response) {
                    if (response){
                        vm.list[index].is_valid = status;
                        // vm.list.splice(index,1);
                    }
                    else
                        err('操作失败');
                }).catch(function (error) {
                    console.log(error);
                });
            },
            editUser:function(index){
                vm.edit=vm.list[index];
                $('#user-add-modal').modal('show');
            },
            delUser:function(user_id,index){
                axios.post('/admin/index/changeTableVal', {
                    'table': 'users',
                    'id_name': 'user_id',
                    'id_value': user_id,
                    'field': 'is_delete',
                    'value': 1,
                }).then(function (response) {
                    if (response){
                        vm.list.splice(index,1);
                    }
                    else
                        err('操作失败');
                }).catch(function (error) {
                    console.log(error);
                });
            }
        },
        updated: function () {
            if (vm.list.length)
                $('.footable').trigger('footable_initialize')

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
        }
    });

    function init() {
        $.ajax({
            type: 'POST',
            url: '/admin/member/index',
            success: function (data) {
                vm.list = data[0];
                vm.level = data[1];
            },
            error: function (xhr, type) {
                err(xhr.responseText);
            }
        });
    }
</script>
{include file="public/footer" /}